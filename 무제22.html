<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ë¡œ ì“°ëŠ” ì¼ê¸°</title>
    <link rel="manifest" href="manifest.json">
    <style>
        .day-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .day-selector label {
            cursor: pointer;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            user-select: none;
        }
        .selected {
            background-color: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ë§ë¡œ ì“°ëŠ” ì¼ê¸°</h1>

    <label for="timePicker">ë…¹ìŒí•  ì‹œê°„ ì„¤ì •:</label>
    <input type="time" id="timePicker">
    <button id="setTimeBtn">ì‹œê°„ ì„¤ì •</button>

    <br><br>

    <label>ë…¹ìŒí•  ìš”ì¼ ì„ íƒ:</label>
    <div class="day-selector">
        <label><input type="checkbox" id="everyday" value="ë§¤ì¼"> ë§¤ì¼</label>
        <label><input type="checkbox" class="weekday" value="ì›”"> ì›”</label>
        <label><input type="checkbox" class="weekday" value="í™”"> í™”</label>
        <label><input type="checkbox" class="weekday" value="ìˆ˜"> ìˆ˜</label>
        <label><input type="checkbox" class="weekday" value="ëª©"> ëª©</label>
        <label><input type="checkbox" class="weekday" value="ê¸ˆ"> ê¸ˆ</label>
        <label><input type="checkbox" class="weekday" value="í† "> í† </label>
        <label><input type="checkbox" class="weekday" value="ì¼"> ì¼</label>
    </div>

    <p id="status">ğŸ™ï¸ ëŒ€ê¸° ì¤‘...</p>
    <p><strong>í…ìŠ¤íŠ¸ ë³€í™˜ ê²°ê³¼:</strong></p>
    <p id="transcription"></p>

    <button id="saveBtn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>

    <h2>ğŸ“‚ ì €ì¥ëœ ì¼ê¸°</h2>
    <ul id="savedNotes"></ul>

    <script>
        let scheduledTime = localStorage.getItem("recordTime") || null;
        let scheduledDays = JSON.parse(localStorage.getItem("recordDays")) || [];
        let recognition;

        document.getElementById("timePicker").value = scheduledTime || "";

        // ğŸ”¹ ìš”ì¼ ì„ íƒ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.querySelectorAll(".day-selector input").forEach(input => {
            input.addEventListener("change", function() {
                if (this.id === "everyday" && this.checked) {
                    document.querySelectorAll(".weekday").forEach(weekday => {
                        weekday.checked = false;
                    });
                } else if (!this.checked && document.querySelectorAll(".weekday:checked").length === 0) {
                    this.checked = true;
                } else {
                    document.getElementById("everyday").checked = false;
                }
            });
        });

        // ğŸ“Œ **ìŒì„± ì¸ì‹ ì„¤ì •**
        async function startRecognition() {
            if (!recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'ko-KR';

                recognition.onstart = function() {
                    document.getElementById("status").innerText = "ğŸ¤ ë…¹ìŒ ì¤‘...";
                };

                recognition.onresult = function(event) {
                    let transcript = event.results[0][0].transcript;
                    document.getElementById("transcription").innerText = transcript;
                    document.getElementById("status").innerText = "âœ… ë…¹ìŒ ì™„ë£Œ!";
                    saveNote(transcript);
                };

                recognition.onerror = function(event) {
                    document.getElementById("status").innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + event.error;
                };

                recognition.onend = function() {
                    document.getElementById("status").innerText = "ğŸ™ï¸ ëŒ€ê¸° ì¤‘...";
                };
            }
            recognition.start();
        }

        // ğŸ“Œ **ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­**
        async function requestMicrophoneAccess() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("âœ… ë§ˆì´í¬ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } catch (error) {
                console.error("ğŸš« ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:", error);
                alert("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ìŒì„± ë…¹ìŒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            }
        }

        // ğŸ“Œ **ì‹œê°„ ì„¤ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì €ì¥**
        document.getElementById("setTimeBtn").addEventListener("click", function() {
            scheduledTime = document.getElementById("timePicker").value;
            let selectedDays = [];
            
            if (document.getElementById("everyday").checked) {
                selectedDays.push("ë§¤ì¼");
            } else {
                document.querySelectorAll(".weekday:checked").forEach(checkbox => {
                    selectedDays.push(checkbox.value);
                });
            }

            if (scheduledTime && selectedDays.length > 0) {
                localStorage.setItem("recordTime", scheduledTime);
                localStorage.setItem("recordDays", JSON.stringify(selectedDays));
                alert(`â° ${selectedDays.join(", ")} ${scheduledTime}ì— ë…¹ìŒì´ ì‹œì‘ë©ë‹ˆë‹¤!`);
                checkTime();
            } else {
                alert("â³ ì‹œê°„ì„ ì„¤ì •í•˜ê³  ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            }
        });

        // ğŸ“Œ **ì‹œê°„ ì²´í¬ í›„ ìë™ ë…¹ìŒ (ëª¨ë°”ì¼ ê°•ì œ ì‹¤í–‰)**
        function checkTime() {
            setInterval(async function() {
                let now = new Date();
                let currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                let currentDay = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "][now.getDay()];

                let selectedDays = JSON.parse(localStorage.getItem("recordDays")) || [];
                let selectedTime = localStorage.getItem("recordTime");

                if (selectedTime === currentTime && (selectedDays.includes(currentDay) || selectedDays.includes("ë§¤ì¼"))) {
                    console.log("ğŸ¤ ìë™ ë…¹ìŒ ì‹œì‘!");
                    await requestMicrophoneAccess();
                    startRecognition();
                }
            }, 1000); // 1ì´ˆë§ˆë‹¤ ì²´í¬
        }

        // ğŸ“Œ **ë©”ëª¨ ì €ì¥í•˜ê¸°**
        function saveNote(text) {
            let notes = JSON.parse(localStorage.getItem("notes")) || [];
            notes.push(text);
            localStorage.setItem("notes", JSON.stringify(notes));
            loadNotes();
        }

        // ğŸ“Œ **ì €ì¥ëœ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°**
        function loadNotes() {
            let notes = JSON.parse(localStorage.getItem("notes")) || [];
            let savedNotesList = document.getElementById("savedNotes");
            savedNotesList.innerHTML = "";
            notes.forEach(note => {
                let li = document.createElement("li");
                li.textContent = note;
                savedNotesList.appendChild(li);
            });
        }

        // ğŸ“Œ **"ì €ì¥í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ˜ë™ ì €ì¥**
        document.getElementById("saveBtn").addEventListener("click", function() {
            let text = document.getElementById("transcription").innerText;
            if (text) {
                saveNote(text);
                alert("âœ… ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
                alert("âš ï¸ ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        });

        // ğŸ“Œ **í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°**
        loadNotes();
        checkTime();

    </script>
</body>
</html>
